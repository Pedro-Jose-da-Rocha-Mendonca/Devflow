#compdef run-story run-story.sh

# Zsh completion for run-story.sh
# Install: Add to fpath or source this file

_run_story_get_story_keys() {
    local project_root="${0:A:h:h:h:h}"  # Navigate up from completions dir
    local sprint_status="$project_root/docs/sprint-status.yaml"

    if [[ -f "$sprint_status" ]]; then
        # Extract abbreviated story keys (e.g., 3-5) - NOT full keys
        grep -E "^  [0-9]+-[0-9]+" "$sprint_status" 2>/dev/null | \
            sed 's/:.*//' | \
            sed 's/^[[:space:]]*//' | \
            sed 's/^\([0-9]*-[0-9]*\).*/\1/' | \
            sort -u
    fi
}

_run_story_get_bugs() {
    local project_root="${0:A:h:h:h:h}"
    local bugs_dir="$project_root/docs/bugs"

    if [[ -d "$bugs_dir" ]]; then
        ls "$bugs_dir" 2>/dev/null | sed 's/\.md$//'
    fi
}

_run_story_get_refactors() {
    local project_root="${0:A:h:h:h:h}"
    local refactors_dir="$project_root/docs/refactors"

    if [[ -d "$refactors_dir" ]]; then
        ls "$refactors_dir" 2>/dev/null | sed 's/\.md$//'
    fi
}

_run_story_get_migrations() {
    local project_root="${0:A:h:h:h:h}"
    local migrations_dir="$project_root/docs/migrations"

    if [[ -d "$migrations_dir" ]]; then
        ls "$migrations_dir" 2>/dev/null | sed 's/\.md$//'
    fi
}

_run_story_get_tech_debt() {
    local project_root="${0:A:h:h:h:h}"
    local debt_dir="$project_root/docs/tech-debt"

    if [[ -d "$debt_dir" ]]; then
        ls "$debt_dir" 2>/dev/null | sed 's/\.md$//'
    fi
}

_run_story() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    local -a greenfield_modes
    greenfield_modes=(
        '--develop:Run development phase only'
        '--dev:Run development phase only (alias)'
        '--review:Run code review phase only'
        '--adversarial:Run adversarial review (critical, Opus)'
        '--adv:Run adversarial review (alias)'
        '--context:Create story context only'
    )

    local -a brownfield_modes
    brownfield_modes=(
        '--bugfix:Fix a bug'
        '--bug:Fix a bug (alias)'
        '--refactor:Refactor code'
        '--investigate:Investigate codebase'
        '--explore:Investigate codebase (alias)'
        '--quickfix:Quick minimal change'
        '--quick:Quick minimal change (alias)'
        '--migrate:Run a migration'
        '--migration:Run a migration (alias)'
        '--tech-debt:Resolve technical debt'
        '--debt:Resolve technical debt (alias)'
    )

    local -a options
    options=(
        '--no-commit:Disable auto-commit after changes'
        '--with-pr:Enable auto-PR creation'
        '--model:Use specific Claude model (sonnet|opus|haiku)'
    )

    local -a models
    models=(
        'sonnet:Claude Sonnet (balanced)'
        'opus:Claude Opus (most capable)'
        'haiku:Claude Haiku (fast, lightweight)'
    )

    _arguments -C \
        '1:story key:->story_key' \
        '*:option:->option'

    case "$state" in
        story_key)
            local -a story_keys
            story_keys=("${(@f)$(_run_story_get_story_keys)}")
            _describe -t stories 'story key' story_keys
            ;;
        option)
            # Check what mode we're in based on previous arguments
            local mode=""
            for arg in "${words[@]}"; do
                case "$arg" in
                    --bugfix|--bug) mode="bugfix" ;;
                    --refactor) mode="refactor" ;;
                    --migrate|--migration) mode="migrate" ;;
                    --tech-debt|--debt) mode="tech-debt" ;;
                esac
            done

            case "$mode" in
                bugfix)
                    local -a bugs
                    bugs=("${(@f)$(_run_story_get_bugs)}")
                    _describe -t bugs 'bug ID' bugs
                    ;;
                refactor)
                    local -a refactors
                    refactors=("${(@f)$(_run_story_get_refactors)}")
                    _describe -t refactors 'refactor ID' refactors
                    ;;
                migrate)
                    local -a migrations
                    migrations=("${(@f)$(_run_story_get_migrations)}")
                    _describe -t migrations 'migration ID' migrations
                    ;;
                tech-debt)
                    local -a debts
                    debts=("${(@f)$(_run_story_get_tech_debt)}")
                    _describe -t debts 'tech-debt ID' debts
                    ;;
            esac

            # Check if --model was just typed
            if [[ "${words[$CURRENT-1]}" == "--model" ]]; then
                _describe -t models 'model' models
                return
            fi

            _describe -t greenfield 'greenfield modes' greenfield_modes
            _describe -t brownfield 'brownfield modes' brownfield_modes
            _describe -t options 'options' options
            ;;
    esac
}

_run_story "$@"
