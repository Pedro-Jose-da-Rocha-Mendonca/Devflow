#!/bin/zsh
################################################################################
# GDS - Unified CLI for GDS Automation
#
# A user-friendly wrapper around all GDS automation scripts with autocomplete
# support and intuitive commands.
#
# Usage:
#   gds <command> [args...]
#   gds story 3-5              # Run full story pipeline
#   gds develop 3-5            # Development only
#   gds adversarial 3-5        # Critical code review
#   gds bugfix login-crash     # Fix a bug
#   gds agent dev              # Invoke dev agent directly
#   gds profile                # Edit user profile
#
################################################################################

set -e

# Resolve script location and project root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Export for completions
export GDS_PROJECT_ROOT="$PROJECT_ROOT"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m'

# Paths
RUN_STORY="$SCRIPT_DIR/run-story.sh"
AGENTS_DIR="$PROJECT_ROOT/.automation/agents"
OVERRIDES_DIR="$PROJECT_ROOT/.automation/overrides"
MEMORY_DIR="$PROJECT_ROOT/.automation/memory"
LOGS_DIR="$PROJECT_ROOT/.automation/logs"

################################################################################
# Help
################################################################################

print_banner() {
    echo ""
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                    GDS AUTOMATION CLI                         ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_help() {
    print_banner
    echo -e "${YELLOW}USAGE:${NC}"
    echo "  gds <command> [arguments] [options]"
    echo ""
    echo -e "${YELLOW}STORY COMMANDS:${NC}"
    echo -e "  ${GREEN}story${NC} <key>           Run full pipeline (context + dev + review)"
    echo -e "  ${GREEN}develop${NC} <key>         Run development phase only"
    echo -e "  ${GREEN}review${NC} <key>          Run standard code review"
    echo -e "  ${GREEN}adversarial${NC} <key>     Run adversarial review (critical, Opus)"
    echo -e "  ${GREEN}context${NC} <key>         Create story context only"
    echo ""
    echo -e "${YELLOW}BROWNFIELD COMMANDS:${NC}"
    echo -e "  ${GREEN}bugfix${NC} <id>           Fix a bug"
    echo -e "  ${GREEN}refactor${NC} <id>         Refactor code"
    echo -e "  ${GREEN}investigate${NC} <topic>   Investigate codebase (read-only)"
    echo -e "  ${GREEN}quickfix${NC} <desc>       Quick, minimal change"
    echo -e "  ${GREEN}migrate${NC} <id>          Run a migration"
    echo -e "  ${GREEN}tech-debt${NC} <id>        Resolve technical debt"
    echo ""
    echo -e "${YELLOW}AGENT COMMANDS:${NC}"
    echo -e "  ${GREEN}agent${NC} <name> [task]   Invoke a specific agent"
    echo -e "  ${GREEN}agents${NC}                List available agents"
    echo ""
    echo -e "${YELLOW}PERSONALIZATION:${NC}"
    echo -e "  ${GREEN}profile${NC}               Edit user profile"
    echo -e "  ${GREEN}override${NC} <agent>      Edit agent override"
    echo -e "  ${GREEN}memory${NC} <agent>        View/manage agent memory"
    echo ""
    echo -e "${YELLOW}UTILITIES:${NC}"
    echo -e "  ${GREEN}status${NC}                Show sprint status"
    echo -e "  ${GREEN}logs${NC} [tail|list]      View automation logs"
    echo -e "  ${GREEN}setup${NC}                 Setup completions and aliases"
    echo -e "  ${GREEN}help${NC}                  Show this help"
    echo ""
    echo -e "${YELLOW}OPTIONS:${NC}"
    echo "  --model <name>      Use specific model (sonnet|opus|haiku)"
    echo "  --no-commit         Disable auto-commit"
    echo "  --with-pr           Enable auto-PR creation"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "  gds story 3-5                    # Full pipeline for story 3-5"
    echo "  gds develop 3-5 --model opus     # Dev with Opus"
    echo "  gds adversarial 3-5              # Critical review"
    echo "  gds bugfix login-crash           # Fix a bug"
    echo "  gds profile                      # Edit your preferences"
    echo ""
    echo -e "${GRAY}Tip: Enable tab completion with 'gds setup'${NC}"
    echo ""
}

################################################################################
# Story Commands
################################################################################

cmd_story() {
    "$RUN_STORY" "$@"
}

cmd_develop() {
    "$RUN_STORY" "$1" --develop "${@:2}"
}

cmd_review() {
    "$RUN_STORY" "$1" --review "${@:2}"
}

cmd_adversarial() {
    "$RUN_STORY" "$1" --adversarial "${@:2}"
}

cmd_context() {
    "$RUN_STORY" "$1" --context "${@:2}"
}

################################################################################
# Brownfield Commands
################################################################################

cmd_bugfix() {
    "$RUN_STORY" "$1" --bugfix "${@:2}"
}

cmd_refactor() {
    "$RUN_STORY" "$1" --refactor "${@:2}"
}

cmd_investigate() {
    "$RUN_STORY" "$1" --investigate "${@:2}"
}

cmd_quickfix() {
    "$RUN_STORY" "$1" --quickfix "${@:2}"
}

cmd_migrate() {
    "$RUN_STORY" "$1" --migrate "${@:2}"
}

cmd_tech_debt() {
    "$RUN_STORY" "$1" --tech-debt "${@:2}"
}

################################################################################
# Agent Commands
################################################################################

cmd_agents() {
    echo ""
    echo -e "${CYAN}Available Agents:${NC}"
    echo ""

    for agent_file in "$AGENTS_DIR"/*.md; do
        if [[ -f "$agent_file" ]]; then
            local name=$(basename "$agent_file" .md)
            local title=$(head -1 "$agent_file" | sed 's/^#[[:space:]]*//')
            local has_override=""

            if [[ -f "$OVERRIDES_DIR/${name}.override.yaml" ]]; then
                has_override=" ${GREEN}[customized]${NC}"
            fi

            printf "  ${GREEN}%-15s${NC} %s%b\n" "$name" "$title" "$has_override"
        fi
    done

    echo ""
}

cmd_agent() {
    local agent_name="$1"
    local task="${@:2}"

    if [[ -z "$agent_name" ]]; then
        echo -e "${RED}Error: Agent name required${NC}"
        cmd_agents
        return 1
    fi

    local agent_file="$AGENTS_DIR/${agent_name}.md"
    if [[ ! -f "$agent_file" ]]; then
        echo -e "${RED}Error: Agent not found: $agent_name${NC}"
        cmd_agents
        return 1
    fi

    echo -e "${CYAN}Invoking agent: $agent_name${NC}"
    echo ""

    # Source the CLI library and use override-aware loading
    source "$SCRIPT_DIR/lib/claude-cli.sh"

    local prompt="${task:-Awaiting instructions. What would you like me to do?}"
    local agent_prompt=$(get_agent_prompt "$agent_name")

    # Interactive mode with the agent
    echo "$prompt" | claude -p \
        --model "$(get_agent_model "$agent_name" "sonnet")" \
        --append-system-prompt "$agent_prompt" \
        --tools "Read,Write,Edit,Grep,Glob,Bash"
}

################################################################################
# Personalization Commands
################################################################################

cmd_profile() {
    local profile_file="$OVERRIDES_DIR/user-profile.yaml"

    if [[ ! -f "$profile_file" ]]; then
        echo -e "${YELLOW}Profile not found. Creating default...${NC}"
        mkdir -p "$OVERRIDES_DIR"
        # Will be created by the system
    fi

    echo -e "${CYAN}Opening user profile...${NC}"
    ${EDITOR:-vim} "$profile_file"
}

cmd_override() {
    local agent_name="$1"

    if [[ -z "$agent_name" ]]; then
        echo ""
        echo -e "${CYAN}Available Overrides:${NC}"
        echo ""

        for override_file in "$OVERRIDES_DIR"/*.override.yaml; do
            if [[ -f "$override_file" ]]; then
                local name=$(basename "$override_file" .override.yaml)
                printf "  ${GREEN}%-15s${NC} %s\n" "$name" "$override_file"
            fi
        done

        echo ""
        echo -e "${GRAY}Usage: gds override <agent-name>${NC}"
        return 0
    fi

    local override_file="$OVERRIDES_DIR/${agent_name}.override.yaml"

    if [[ ! -f "$override_file" ]]; then
        echo -e "${YELLOW}Creating new override for: $agent_name${NC}"
        mkdir -p "$OVERRIDES_DIR"

        cat > "$override_file" << 'EOF'
# Agent Override
# Customize this agent's behavior without modifying the core agent file

# Additional rules (appended to base agent rules)
additional_rules:
  - "Add your custom rules here"

# Memories - facts this agent should always remember
memories:
  - "Add project-specific context here"

# Critical actions - must be done before completing any task
critical_actions:
  - "Add pre-completion checks here"

# Model override (optional)
# model: "opus"

# Budget override (optional)
# max_budget_usd: 10.00
EOF
    fi

    echo -e "${CYAN}Opening override: $agent_name${NC}"
    ${EDITOR:-vim} "$override_file"
}

cmd_memory() {
    local subcmd="$1"
    local agent_name="$2"

    case "$subcmd" in
        show|"")
            if [[ -z "$agent_name" ]]; then
                echo ""
                echo -e "${CYAN}Agent Memories:${NC}"
                echo ""

                for memory_file in "$MEMORY_DIR"/*.memory.md; do
                    if [[ -f "$memory_file" ]]; then
                        local name=$(basename "$memory_file" .memory.md)
                        local count=$(wc -l < "$memory_file" | tr -d ' ')
                        printf "  ${GREEN}%-15s${NC} %s entries\n" "$name" "$count"
                    fi
                done

                echo ""
                echo -e "${GRAY}Usage: gds memory show <agent>${NC}"
                return 0
            fi

            local memory_file="$MEMORY_DIR/${agent_name}.memory.md"
            if [[ -f "$memory_file" ]]; then
                echo -e "${CYAN}Memory for: $agent_name${NC}"
                echo ""
                cat "$memory_file"
            else
                echo -e "${YELLOW}No memories for: $agent_name${NC}"
            fi
            ;;

        add)
            if [[ -z "$agent_name" ]]; then
                echo -e "${RED}Error: Agent name required${NC}"
                return 1
            fi

            local entry="${@:3}"
            if [[ -z "$entry" ]]; then
                echo -e "${RED}Error: Memory entry required${NC}"
                echo "Usage: gds memory add <agent> <memory text>"
                return 1
            fi

            mkdir -p "$MEMORY_DIR"
            local memory_file="$MEMORY_DIR/${agent_name}.memory.md"
            echo "- $(date '+%Y-%m-%d %H:%M'): $entry" >> "$memory_file"
            echo -e "${GREEN}Memory added for: $agent_name${NC}"
            ;;

        clear)
            if [[ -z "$agent_name" ]]; then
                echo -e "${RED}Error: Agent name required${NC}"
                return 1
            fi

            local memory_file="$MEMORY_DIR/${agent_name}.memory.md"
            if [[ -f "$memory_file" ]]; then
                rm "$memory_file"
                echo -e "${GREEN}Memory cleared for: $agent_name${NC}"
            else
                echo -e "${YELLOW}No memories to clear for: $agent_name${NC}"
            fi
            ;;

        *)
            echo "Usage: gds memory [show|add|clear] <agent>"
            ;;
    esac
}

################################################################################
# Utility Commands
################################################################################

cmd_status() {
    local sprint_status="$PROJECT_ROOT/docs/sprint-status.yaml"

    if [[ ! -f "$sprint_status" ]]; then
        echo -e "${RED}Sprint status file not found${NC}"
        return 1
    fi

    echo ""
    echo -e "${CYAN}Sprint Status:${NC}"
    echo ""
    cat "$sprint_status"
    echo ""
}

cmd_logs() {
    local subcmd="${1:-tail}"

    case "$subcmd" in
        tail)
            local current_log="$LOGS_DIR/current.log"
            if [[ -L "$current_log" ]] && [[ -f "$current_log" ]]; then
                echo -e "${CYAN}Tailing current log...${NC}"
                tail -f "$current_log"
            else
                echo -e "${YELLOW}No active log. Recent logs:${NC}"
                ls -lt "$LOGS_DIR"/*.log 2>/dev/null | head -5
            fi
            ;;

        list)
            echo -e "${CYAN}Recent logs:${NC}"
            ls -lt "$LOGS_DIR"/*.log 2>/dev/null | head -20
            ;;

        view)
            local log_name="$2"
            if [[ -z "$log_name" ]]; then
                echo "Usage: gds logs view <log-name>"
                return 1
            fi
            ${PAGER:-less} "$LOGS_DIR/${log_name}"*.log
            ;;

        clean)
            echo -e "${YELLOW}Cleaning logs older than 7 days...${NC}"
            find "$LOGS_DIR" -name "*.log" -mtime +7 -delete
            echo -e "${GREEN}Done${NC}"
            ;;

        *)
            echo "Usage: gds logs [tail|list|view|clean]"
            ;;
    esac
}

cmd_setup() {
    echo ""
    echo -e "${CYAN}Setting up GDS CLI completions...${NC}"
    echo ""

    local completions_dir="$SCRIPT_DIR/completions"
    local zshrc="$HOME/.zshrc"

    # Create the setup lines
    local setup_lines="
# GDS Automation CLI
export GDS_PROJECT_ROOT=\"$PROJECT_ROOT\"
fpath=($completions_dir \$fpath)
alias gds=\"$SCRIPT_DIR/gds\"
alias run-story=\"$RUN_STORY\"
source \"$completions_dir/gds-interactive.zsh\"
"

    # Check if already installed
    if grep -q "GDS Automation CLI" "$zshrc" 2>/dev/null; then
        echo -e "${YELLOW}GDS completions already in .zshrc${NC}"
        echo -e "${YELLOW}Updating to latest version...${NC}"
        # Remove old block and add new
        sed -i '' '/# GDS Automation CLI/,/gds-interactive.zsh/d' "$zshrc" 2>/dev/null || true
        sed -i '' '/# GDS Automation CLI/,/run-story/d' "$zshrc" 2>/dev/null || true
        echo "$setup_lines" >> "$zshrc"
        echo -e "${GREEN}Updated GDS completions in .zshrc${NC}"
    else
        echo "$setup_lines" >> "$zshrc"
        echo -e "${GREEN}Added GDS completions to .zshrc${NC}"
    fi

    echo ""
    echo -e "${CYAN}To activate now, run:${NC}"
    echo ""
    echo "  source ~/.zshrc"
    echo "  autoload -Uz compinit && compinit"
    echo ""
    echo -e "${CYAN}Interactive completion:${NC}"
    echo ""
    echo "  ${GREEN}Alt+.${NC}        Open visual command menu"
    echo "  ${GREEN}gds.${NC}         Quick command menu"
    echo "  ${GREEN}gds.story${NC}    Quick story selection"
    echo "  ${GREEN}gds.agent${NC}    Quick agent selection"
    echo ""
    echo -e "${CYAN}Tab completion:${NC}"
    echo ""
    echo "  gds <TAB>              See all commands"
    echo "  gds story <TAB>        See story keys"
    echo "  gds develop 3-<TAB>    Complete story key"
    echo ""
}

################################################################################
# Main
################################################################################

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        # Story commands
        story)      cmd_story "$@" ;;
        develop)    cmd_develop "$@" ;;
        review)     cmd_review "$@" ;;
        adversarial|adv) cmd_adversarial "$@" ;;
        context)    cmd_context "$@" ;;

        # Brownfield commands
        bugfix|bug)     cmd_bugfix "$@" ;;
        refactor)       cmd_refactor "$@" ;;
        investigate|explore) cmd_investigate "$@" ;;
        quickfix|quick) cmd_quickfix "$@" ;;
        migrate)        cmd_migrate "$@" ;;
        tech-debt|debt) cmd_tech_debt "$@" ;;

        # Agent commands
        agent)      cmd_agent "$@" ;;
        agents)     cmd_agents ;;

        # Personalization
        profile)    cmd_profile ;;
        override)   cmd_override "$@" ;;
        memory)     cmd_memory "$@" ;;

        # Utilities
        status)     cmd_status ;;
        logs)       cmd_logs "$@" ;;
        setup)      cmd_setup ;;
        help|-h|--help) print_help ;;

        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            print_help
            exit 1
            ;;
    esac
}

main "$@"
